#!/usr/bin/env bash
#
# =====================================================================
# Raspberry Pi OS (Trixie) — Installation & Configuration Cheat Sheet
# Pi 4 / Pi 5
#
# IMPORTANT:
#   THIS IS NOT A BASH SCRIPT.
#
#   This file is a HUMAN-READABLE CHEAT SHEET written in a bash-like
#   format for clarity, consistency, and easy copy/paste.
#
#   - Do NOT attempt to run this file end-to-end.
#   - Commands are meant to be copied selectively into a terminal.
#   - Sections are intentionally verbose and heavily commented.
#
# STYLE:
#   - Bash-like layout for readability
#   - Heavy comments for explanation and future recall
#   - Safe, repeatable patterns preferred over one-off edits
#
# KEY CONSTRAINTS (AUTHORITATIVE):
#   - IPv6 DISABLED system-wide
#   - nftables firewall with VPN-aware LAN isolation
#   - SFTP via SSH (NO FTP server)
#   - NFS server OPTIONAL, NFSv4 ONLY
#
# CONFIG FILE WRITING STRATEGY (IMPORTANT):
#   - User-owned files ($HOME):
#       * plain redirection (>, >>)
#       * NO sudo
#   - Root-owned files (/etc, /usr):
#       * use: sudo tee file <<EOF
#       * do NOT rely on shell redirection with sudo
#   - Prefer drop-in directories (/etc/*.d/) where supported
#   - Use managed BEGIN/END marker blocks for idempotency
#
# =====================================================================


# ---------------------------------------------------------------------
# 1. BASE SYSTEM UPDATE STRATEGY (COMMON)
# ---------------------------------------------------------------------
#
# Use ONE upgrade strategy only.
# On Debian-family systems (including Pi OS):
#   - sudo apt full-upgrade == sudo apt dist-upgrade
# So, prefer apt full-upgrade as the modern, clearer form.
#

sudo apt update
sudo apt full-upgrade -y
sudo reboot now


# ---------------------------------------------------------------------
# 2. CORE UTILITIES & USER ENVIRONMENT (COMMON)
# ---------------------------------------------------------------------

# 2.1 Core utilities used throughout
# ----------------------------------
sudo apt install -y \
    curl \
    wget \
    dos2unix \
    less \
    vim \
    htop \
    rsync


# 2.2 User group membership (quality-of-life)
# -------------------------------------------
#
# plugdev         -> access to removable media
# systemd-journal -> read logs without sudo
#
sudo usermod -aG plugdev pi
sudo usermod -aG systemd-journal pi
#
# NOTE:
#   Group changes require reboot to take effect.


# 2.3 Bash aliases — MANAGED BLOCK (idempotent, user-owned)
# ---------------------------------------------------------
#
# Raspberry Pi OS sources ~/.bash_aliases automatically from ~/.bashrc.
# Aliases belong in ~/.bash_aliases, NOT ~/.bashrc.
#
# This block:
#   - is safe to run multiple times
#   - replaces only the content between BEGIN/END markers
#   - does not affect aliases outside the managed block
#

ALIASES_FILE="${HOME}/.bash_aliases"
BEGIN_MARK="# >>> CHEATSHEET:ALIASES BEGIN >>>"
END_MARK="# <<< CHEATSHEET:ALIASES END <<<"

touch "${ALIASES_FILE}"

sed -i "\|^${BEGIN_MARK}$|,\|^${END_MARK}$|d" "${ALIASES_FILE}"

cat >> "${ALIASES_FILE}" <<'EOF'
# >>> CHEATSHEET:ALIASES BEGIN >>>

# --- General ---
alias ll='ls -lah --color=auto'
alias dfh='df -hT'
alias duh='du -h --max-depth=1'

# Journal viewing:
# - jctl  : works without sudo if user is in systemd-journal group
# - sjctl : always works (explicit sudo)
alias jctl='journalctl -xe'
alias sjctl='sudo journalctl -xe'

# nftables ruleset quick view
alias nfr='sudo nft list ruleset'

# --- Raspberry Pi specific ---
alias checktemp='/usr/bin/vcgencmd measure_temp'

# --- Process diagnostics ---
# Top CPU consumers (full list)
alias pscpu='ps aux --sort=-%cpu'
# Top CPU consumers (top 20)
alias pscpu20='ps aux --sort=-%cpu | head -n 20'

# Top memory consumers (full list)
alias psmem='ps aux --sort=-%mem'
# Top memory consumers (top 20)
alias psmem20='ps aux --sort=-%mem | head -n 20'

# <<< CHEATSHEET:ALIASES END <<<
EOF

# Optional: activate immediately in current shell
# source "${ALIASES_FILE}"


# ---------------------------------------------------------------------
# 3. DESKTOP, LOCALISATION & UI POLICY (AUTHORITATIVE)
# ---------------------------------------------------------------------
#
# AUTHORITATIVE DESKTOP POLICY
# The following defines the REQUIRED baseline configuration.
# Deviations should be deliberate and well documented.
#
# Control Centre & Desktop Settings:
#   - Large-screen defaults
#   - Desktop background: fjord.jpg
#   - Boot to desktop: ON
#   - Auto-login (CLI): OFF
#   - Auto-login (GUI): OFF
#   - Mouse acceleration: FASTEST
#   - Splash screen: OFF
#   - Performance fan: ON
#
# Services:
#   - SSH: ON
#   - VNC: ON
#
# Localisation:
#   - Locale: en_AU.UTF-8
#   - Timezone: Australia/Adelaide
#   - Keyboard: English (Australia)
#   - Wi-Fi country: Australia
#
# NOTE:
#   Some settings are GUI-only; this section records intent.


# 3.1 RASPI-CONFIG SETTINGS (COMMON / PI 5 NOTES)
# -----------------------------------------------
#
# Run:
sudo raspi-config
#
# Set / verify:
#   - Bootloader: latest
#   - Expand filesystem
#   - Boot to Desktop (NO auto-login)
#   - Screen blanking: OFF
#   - Localisation: verify ALL four options (locale, timezone, keyboard, Wi-Fi)
#


# 3.2 NETWORK MANAGER VERIFICATION & ROUTING
# ------------------------------------------
# NOTE:  Pi OS Trixie uses NetworkManager by default.
systemctl status NetworkManager
nmcli device status

# Prefer Ethernet over Wi-Fi using route metrics
# Lower metric = higher priority.
#
# IMPORTANT:
#   These are CONNECTION PROFILE NAMES, not interface names.
#   Discover names with:
nmcli connection show
#
# Example with specific WiFi SSID name based profiles:
sudo nmcli connection modify netplan-eth0 ipv4.route-metric 100 ipv6.route-metric 100
sudo nmcli connection modify netplan-wlan0-D880L50 ipv4.route-metric 600 ipv6.route-metric 600
sudo nmcli connection modify netplan-wlan0-D880L24 ipv4.route-metric 600 ipv6.route-metric 600
sudo nmcli connection up netplan-eth0
sudo nmcli connection up netplan-wlan0-D880L50
sudo nmcli connection up netplan-wlan0-D880L24
#
# Check the interface priority metrics:
ip route show default


# 3.3 IPV6 POLICY — DISABLED
# --------------------------
#
# IPv6 is intentionally disabled on this LAN.
# This simplifies routing, firewalling, and VPN behaviour.
#

sudo tee /etc/sysctl.d/99-disable-ipv6.conf >/dev/null <<'EOF'
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
EOF

sudo sysctl --system

# Verify ipv6:
ip -6 addr
ip -6 route

# NOTE:
#   VPN software may encapsulate IPv6 internally; this setting affects
#   the host network stack only.


# ---------------------------------------------------------------------
# 4. FIREWALL: NFTABLES + VPN-AWARE LAN ISOLATION (COMMON)
# ---------------------------------------------------------------------
#
# NOTE:
# Baseline NFTABLES firewall rules to ensure LAN isolation from NORDvpn tunnels and elsewhere.
#
# Custom installer script:
#   install-nft-vpn-lan-isolation.sh
# which creates:
#   - /etc/nftables.conf
#   - /usr/local/sbin/vpn-lan-isolation.sh
#   - NetworkManager dispatcher hook /etc/NetworkManager/dispatcher.d/90-vpn-lan-isolation
#
# Behaviour:
#   - assumes LAN is 10.0.0.0/24 and LAN gateway is 10.0.0.1
#   - sets up Dynamically detecting Ethernet/WiFi up and down and adjusts rules accordingly
#   - sets up Dynanically detecting NORDvpn tunnels up/down and adjusts rules accordingly
#   - INPUT  default DROP
#   - OUTPUT default ACCEPT
#   - VPN UP   -> LAN isolated (except gateway)
#   - VPN DOWN -> LAN access restored
#
# Main script to setup NFTABLES firewall rules 
# --------------------------------------------
sudo bash ./install-nft-vpn-lan-isolation.sh
#
# It creates this file: /usr/local/sbin/vpn-lan-isolation.sh and runs it
#    sudo /usr/local/sbin/vpn-lan-isolation.sh
#
# The created file vpn-lan-isolation.sh
# -------------------------------------
# - This script is NOT a daemon.
# - Once the main script has run, it is invoked automatically by NetworkManager on:
#     * interface up/down
#     * VPN connect/disconnect
#     * routing changes
# - Each run re-evaluates current VPN state and re-applies the correct firewall rules.
# - Safe to run repeatedly; no persistent state is kept.
#
# For clarity,
#
# The script
# is * **NOT** a one-shot script
# is * **NOT** a daemon
# is * **NOT** something you run continuously
#
# It is a **small policy-enforcement helper** that is:
# 1. **Called automatically** by NetworkManager when network state changes
# 2. **Safe to run manually** for testing, debugging, or forcing state
# 3. **Idempotent** — running it multiple times just re-applies the same rules
# 
# *** Think of it as:
#
# > “Re-apply the correct firewall rules *for the current VPN state*.”
#
# *** When is "/usr/local/sbin/vpn-lan-isolation.sh" run automatically?
# ---------------------------------------------------------------------
# The key mechanism: NetworkManager dispatcher
# During installation, these files are created:
#   "/usr/local/sbin/vpn-lan-isolation.sh" <- despatcher script (invoked by NetworkManager upon network changes)
#   "/etc/NetworkManager/dispatcher.d/90-vpn-lan-isolation" <- actioner script
#
# NetworkManager runs **every executable script in /etc/NetworkManager/dispatcher.d/** when *any* of these events occur:
#   * Network interface goes **up**
#   * Network interface goes **down**
#   * Wi-Fi connects / disconnects
#   * Ethernet cable plugged / unplugged
#   * VPN connects
#   * VPN disconnects
#   * Routing changes
#   * DNS changes
# On each event, NetworkManager calls the dispatcher script with arguments like:
#   <interface-name> <action>
# Example:
#   wlan0 up
#   eth0 down
#   nordlynx0 up
# The dispatcher script does **one thing** ... call /usr/local/sbin/vpn-lan-isolation.sh like this: 
#   /usr/local/sbin/vpn-lan-isolation.sh apply
# So:
#   **Every time network state changes**, the helper script /usr/local/sbin/vpn-lan-isolation.sh is run automatically by the despatcher.
#
# *** What does `vpn-lan-isolation.sh apply` actually do?
# -------------------------------------------------------
# Internally, it:
# 1. **Detects whether a VPN interface is currently UP**
#   * looks for `nordlynx`, `tun*`, `wg*`
# 2. Chooses one of two policies:
#   * **VPN UP → LAN ISOLATED**
#   * **VPN DOWN → LAN ALLOWED**
# 3. **Flushes and re-installs** only the *relevant nftables sets / rules*
# 4. Exits
#
# There is **no memory**, no background state, no “previous mode”.
# Each run answers the question:
#   “Given the *current* system state, what should the firewall look like?”
#
# *** Is the the Installer Script install-nft-vpn-lan-isolation.sh run once or many times?
# ----------------------------------------------------------------------------------------
# Installer script (`install-nft-vpn-lan-isolation.sh`)
#   * Run **once per system**
#   * Purpose:
#     * install nftables
#     * install helper
#     * install dispatcher hook
#   * You normally never run this again unless reinstalling the system
#
# Helper script (`vpn-lan-isolation.sh`)
#   * Run:
#     * **Automatically**: many times over system lifetime
#     * **Manually**: whenever you want
#   * It is expected to run **frequently** being called by the despatcher /etc/NetworkManager/dispatcher.d/90-vpn-lan-isolation
#
# *** Why is it designed this way?
# --------------------------------
# This design avoids several common problems.
#   1. No reliance on VPN client hooks
#   Many VPN guides say:
#      > “Add firewall rules when VPN connects”
#   That fails when:
#     * VPN crashes
#     * VPN auto-reconnects
#     * System resumes from sleep
#     * NetworkManager reorders routes
#   Here, the firewall logic is **independent** of the VPN client.
#
#   2. No race conditions
#   There is no:
#     * “remember last state”
#     * “toggle mode”
#     * “if already applied, skip”
#   Every run is a **full reconciliation**.
#   This means:
#     * boot order doesn’t matter
#     * interface order doesn’t matter
#     * Wi-Fi vs Ethernet doesn’t matter
#
#   3. Works across reboots, hotplug, roaming
#   Example timeline:
#     1. Boot system (no VPN yet)
#        * dispatcher runs → VPN DOWN → LAN allowed
#     2. NordVPN connects
#        * dispatcher runs → VPN UP → LAN blocked
#     3. Ethernet unplugged, Wi-Fi connects
#        * dispatcher runs → VPN still UP → LAN blocked
#     4. VPN disconnects
#        * dispatcher runs → VPN DOWN → LAN allowed
#   No special cases.
#
# *** Why not just rely on nftables “dynamic rules”?
# --------------------------------------------------
# Because nftables **does not know** whether a VPN is “up” in the semantic sense.
#   * nftables can match interfaces
#   * but VPN interfaces can appear/disappear
#   * interface names can vary
# The helper script bridges the gap between:
#   * **system state** (VPN present or not)
#   * **static firewall policy**
#
# *** When would *you* run it manually?
# -------------------------------------
# You normally wouldn’t — but it’s useful for:
#   * Testing / debugging
#        sudo /usr/local/sbin/vpn-lan-isolation.sh status
#        sudo /usr/local/sbin/vpn-lan-isolation.sh apply
#   * Forcing a re-evaluation
#        /usr/local/sbin/vpn-lan-isolation.sh apply
#   * Temporarily overriding (rare)
#        sudo /usr/local/sbin/vpn-lan-isolation.sh off
#     (then later)
#        sudo /usr/local/sbin/vpn-lan-isolation.sh on
# But in normal operation, **NetworkManager does all of the work**.
# ----

# LIST CURRENT NetworkManager RULES:
sudo nft list ruleset

# ---------------------------------------------------------------------
# 5. REMOTE ACCESS & FILE TRANSFER
# ---------------------------------------------------------------------
#
# SSH on the Pi provides the following which are usef for remote connections and for file exchange:
#   - shell access
#   - SFTP (FileZilla)
#   - scp / rsync
# check the status of SSH on the Pi:

systemctl status ssh

#
# 5.1 FTP/FTPS/SFTP SERVER
# ------------------------
# No FTP server is installed or required since we can use SSH without further software complexity.
# FileZilla on a PC can be configured to use **SFTP (SSH File Transfer Protocol)**.
#
# IMPORTANT:
#   - SFTP is NOT FTP.
#   - No FTP server runs on the Pi.
#   - SFTP is provided automatically out-of-the-box by the SSH server (sshd).
# WHY SFTP:
#   - Encrypted (unlike classic FTP)
#   - Uses the same authentication as SSH
#   - No additional server to install, configure, or firewall
#   - Works cleanly with nftables and VPN LAN isolation
# RECOMMENDED PRACTICE FOR SYSTEM FILES:
#   - Use VNC or SSH terminal for editing (/etc, /usr, etc.)
#   - Or copy files via SFTP, edit locally, then replace using sudo
#     from an SSH shell if needed.
# VPN INTERACTION:
#   - When VPN is UP:
#       * LAN access (including SFTP from PC) is intentionally blocked.
#   - When VPN is DOWN:
#       * Normal SFTP access from the LAN works.
# This behaviour is enforced by nftables + vpn-lan-isolation.sh
# and is by design.
#
# WHY FTP / FTPS SERVERS ARE NOT USED ON THIS PI
# ----------------------------------------------
# FTP (File Transfer Protocol):
#   - Sends credentials in clear text (insecure)
#   - Requires multiple ports (control + data)
#   - Complicated firewall rules (active/passive modes)
#   - Poor interaction with VPN-aware firewalling
# FTPS (FTP over TLS):
#   - Encrypts traffic, but:
#       * still requires multiple dynamic ports
#       * significantly complicates nftables rules
#       * harder to reason about when VPN is up/down
#   - Requires an additional daemon and certificate management
# DESIGN DECISION:
#   FTP / FTPS are deliberately NOT installed.
# SFTP (over SSH) is preferred because:
#   - Single well-known port (22)
#   - Encrypted by default
#   - Uses existing SSH authentication
#   - Minimal firewall surface
#   - Predictable behaviour with VPN LAN isolation
# This keeps the system simpler, safer, and easier to audit.
#
#
# 5.2 WINDOWS PC FTP CLIENT - FILEZILLA
# -------------------------------------
# FILEZILLA SETTINGS:
#   Protocol:  SFTP – SSH File Transfer Protocol
#   Host:      Pi hostname or LAN IP (e.g. 10.0.0.x)
#   Port:      22
#   Username:  pi  (or other local user)
#   Password:  Pi user password (or SSH key if configured)
# WHAT YOU SEE IN FILEZILLA:
#   - The remote pane shows a normal directory tree.
#   - Visibility is governed by standard Unix permissions.
#   - You can browse:
#       * /home/pi
#       * /mnt/...
#       * /srv/...
#       * external disks
# WHAT YOU CANNOT DO DIRECTLY:
#   - Edit root-owned system files in-place without privileges
#     (e.g. /etc files).
# WINDOWS PC FILEZILLA CLIENT (SFTP) — COMMON GOTCHAS & NOTES
# 1. Passive / Active mode:
#    - NOT APPLICABLE to SFTP.
#    - SFTP uses a single encrypted SSH channel.
#    - Ignore FileZilla FTP mode settings.
# 2. Symbolic links:
#    - FileZilla shows symlinks as folders or files.
#    - Behaviour depends on the target permissions.
#    - Symlinks pointing outside accessible paths may appear broken.
# 3. Permissions & ownership:
#    - FileZilla obeys Unix permissions strictly.
#    - Root-owned files (e.g. /etc/*) are readable only if permitted.
#    - Writes to root-owned paths will fail without sudo.
# 4. Editing files:
#    - Avoid editing system config files directly via SFTP.
#    - Preferred workflow:
#        * edit via VNC or SSH terminal with sudo
#        * OR copy file out, edit locally, then replace using sudo
# 5. Large directory trees:
#    - Browsing very large mounts (e.g. mergerfs media trees)
#      may be slow on first expansion.
#    - This is normal and reflects real filesystem traversal.
# 6. VPN interaction (IMPORTANT):
#    - When VPN is UP:
#        * FileZilla connections from LAN will FAIL (by design).
#    - When VPN is DOWN:
#        * FileZilla SFTP access works normally.
# This behaviour is enforced by nftables + vpn-lan-isolation.sh
# and is intentional.
#
#
# 5.3 VNC SERVER — NATIVE WAYLAND WAYVNC SERVER WITH PAM AUTH
# -----------------------------------------------------------
#
# Policy:
#   - Use Pi user/password (PAM authentication)
#   - No VNC-specific password to connect, use pi native username/password instead
#   - IPv4 ONLY binding (IPv6 was disabled system-wide)
#

sudo mkdir -p /etc/wayvnc
sudo tee /etc/wayvnc/config >/dev/null <<'EOF'
use_relative_paths=true
# IPv4-only binding (do NOT use address=::)
address=0.0.0.0
enable_auth=true
enable_pam=true
private_key_file=tls_key.pem
certificate_file=tls_cert.pem
rsa_private_key_file=rsa_key.pem
EOF

sudo reboot now

# IMPORTANT NOTE ABOUT CONFIG PRECEDENCE:
# --- later overrides earlier:
# 2. global config (can be overridden by a local config)
#   /etc/wayvnc/config
# 1. an existing user-specific (based on ~) config overrides the global config
#   ~/.config/wayvnc/config
#
# So ... Ensure that users do NOT have per-user configs if global policy is desired.
#
#
# 5.4 WINDOWS PC VNC CLIENT - TigerVNC Viewer Standalone Version
# --------------------------------------------------------------
#
# On the Windows PC visit
#   https://github.com/TigerVNC/tigervnc/releases
# Review the release notes.
# TigerVNC Binaries are available from SourceForge, so visit
#   https://sourceforge.net/projects/tigervnc/files
# Then navigate down to the correct sub-folder in that SourceForge webpage
# which contains the binary we need (either beta or stable).
#
# The TigerVNC Viewer Standalone Version .exe file will have this format:
#   vncviewer64-1.15.90.exe
# Note in the filename "64" denoting 64bit, followed by the version.
# Download the correct "vncviewer64" version to the PC and put it somewhere accessible.
#
# 
#


# ---------------------------------------------------------------------
# 6. STORAGE & FILESYSTEM LAYOUT (COMMON)
# ---------------------------------------------------------------------
#
# Recommended:
#   /mnt/diskX     -> physical disks
#   /srv/media     -> mergerfs mount
#

# ---------------------------------------------------------------------
# 6.1 MERGERFS — INSTALLATION, VERIFICATION, AND REINSTALLATION
# ---------------------------------------------------------------------
#
# mergerfs is a critical component in this system.
# It is therefore treated conservatively:
#   - verify first
#   - reinstall only if necessary
#   - configuration (fstab options, policies) is handled separately
#
# This section deals ONLY with:
#   - checking what is installed
#   - installing or reinstalling mergerfs itself
# Filesystem layout, mount options, and policies are documented later.

# STEP 6.1.1 CHECK WHETHER MERGERFS IS INSTALLED
# ----------------------------------------------
# Check if mergerfs binary exists and is runnable
which mergerfs
mergerfs --version

# If the above fails, mergerfs is not installed.

# Check via dpkg (more authoritative)
dpkg -l | grep -i mergerfs

# Expected:
#   ii  mergerfs   <version>   <architecture>
#
# If no output:
#   mergerfs is not installed.

# STEP 6.1.1: ALTEST RELEASE (GITHUB) INSTALLATION
# ------------------------------------------------
#
# This introduces maintenance overhead and must be documented.
#
# IMPORTANT:
#   - remove the distro version cleanly first
#   - install the .deb explicitly
#   - consider apt pinning to avoid silent replacement
#
# Example workflow (adjust paths and version as required):

# Remove existing version (does NOT remove config files)
sudo apt remove --purge -y mergerfs

# Install pinned .deb
sudo dpkg -i /path/to/mergerfs_<version>_arm64.deb

# Resolve dependencies if needed
sudo apt -f install

# Verify
mergerfs --version
dpkg -l | grep -i mergerfs


# STEP 6.1.2 ALTERNATIVE APT DISTRO VERSION which may not be up-to-date
# ---------------------------------------------------------------------
# Default preference:
#   - use the Raspberry Pi OS / Debian repository version
#
# Advantages:
#   - integrates cleanly with apt
#   - receives security updates
#   - predictable behaviour across upgrades

sudo apt update
sudo apt install -y mergerfs

# Verify after install
mergerfs --version
dpkg -l | grep -i mergerfs

# ---------------------------------------------------------------------
# STEP 5: POST-INSTALLATION NOTES (IMPORTANT)
# ---------------------------------------------------------------------
#
# Installing or reinstalling mergerfs:
#   - does NOT mount anything automatically
#   - does NOT alter existing fstab entries
#   - does NOT change disk contents
#
# Mount behaviour is entirely controlled by:
#   - /etc/fstab
#   - systemd mount ordering
#   - mergerfs options (documented later)
#
# This separation is intentional.
#
# Configuration examples, mount options, and policy decisions
# are handled in a later section once the final disk layout is known.
#
# ---------------------------------------------------------------------



# ---------------------------------------------------------------------
# 7. FILE SHARING & MEDIA SERVICES
# ---------------------------------------------------------------------

# 7.1 SAMBA (COMMON)
sudo apt install -y samba samba-common-bin
systemctl status smbd


# 7.2 MINIDLNA (OPTIONAL)
#
# sudo apt install -y minidlna
# sudo systemctl enable --now minidlna


# 7.3 INOTIFY TUNING (COMMON)
#
sudo tee /etc/sysctl.d/99-inotify.conf >/dev/null <<'EOF'
fs.inotify.max_user_watches=524288
fs.inotify.max_user_instances=1024
EOF

sudo sysctl --system


# 7.4 NFS SERVER — OPTIONAL, SERVER-ONLY, NFSv4
#
# Install:
#   sudo apt install -y nfs-kernel-server
#
# Example /etc/exports:
#   /srv/media 10.0.0.0/24(rw,sync,no_subtree_check,fsid=0)
#
# Firewall:
#   TCP 2049 only
#
# Avoid:
#   - rpcbind
#   - NFSv3


# ---------------------------------------------------------------------
# 8. PI 5 ONLY — HARDWARE & FIRMWARE
# ---------------------------------------------------------------------

# 8.1 RTC (PI 5 ONLY)
timedatectl
ls /sys/class/rtc/rtc0/

# 8.2 PCIe Gen 3 (PI 5 ONLY)
# /boot/firmware/config.txt:
#   dtparam=pciex1_gen=3

# 8.3 USB POWER NOTES (PI 5 ONLY)
# usb_max_current_enable=1  (use only if required)


# ---------------------------------------------------------------------
# 9. OPERATIONAL CHECKLIST
# ---------------------------------------------------------------------
#
# - Verify VPN up/down LAN isolation
# - Verify SSH/SFTP, VNC, SMB
# - Backup:
#     /etc/fstab
#     /etc/samba/smb.conf
#     /etc/nftables.conf
#     this cheat sheet
#
# =====================================================================
# END OF CHEAT SHEET v0.5
# =====================================================================
